# Dockerfile.dev - Mode d√©veloppement pour le backend
FROM node:18-alpine

# Installer les outils n√©cessaires
RUN apk add --no-cache \
    curl \
    postgresql-client \
    git \
    openssl \
    && rm -rf /var/cache/apk/*

WORKDIR /app

# Copier package.json pour installer les d√©pendances
COPY package*.json ./

# Installer toutes les d√©pendances (y compris dev)
RUN npm install

# Installer nodemon globalement si pas dans les d√©pendances
RUN npm list nodemon || npm install -g nodemon

# Le code sera mont√© via volume, pas copi√©
# Cr√©er les dossiers n√©cessaires
RUN mkdir -p uploads logs temp prisma

# Exposer le port
EXPOSE 3000

# Variables d'environnement pour le d√©veloppement
ENV NODE_ENV=development
ENV PORT=3000

# Script de d√©marrage pour le d√©veloppement
CMD ["sh", "-c", "\
  echo 'üöÄ D√©marrage en mode d√©veloppement...' && \
  echo 'Attente de la base de donn√©es...' && \
  sleep 5 && \
  if [ -f prisma/schema.prisma ]; then \
    echo 'üìä G√©n√©ration du client Prisma...' && \
    npx prisma generate && \
    echo 'üîÑ Application des migrations...' && \
    npx prisma migrate dev --name init || \
    npx prisma db push || \
    echo 'Impossible d\\'appliquer les migrations'; \
  fi && \
  echo '‚ö° D√©marrage avec hot reload...' && \
  npm run dev \
"]
